name: staging-base-build-deploy

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Build and push
      env:
        DOCKER_BUILDKIT: 1
        MATRIX_PASSWORD: ${{ secrets.MATRIX_PASSWORD }}
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        TERRATEAM_ENVIRONMENT: "staging"
      run: |
        curl -L https://fly.io/install.sh | sh
        flyctl auth docker
        docker build -t registry.fly.io/terrateam-app-$TERRATEAM_ENVIRONMENT:base -f docker/terrat/Dockerfile.base .
        docker push registry.fly.io/terrateam-app-staging:base
        MATRIX_ACCESS_TOKEN=$(curl -s -XPOST -d '{"type":"m.login.password", "user":"terrateam", "password":'\"$MATRIX_PASSWORD\"'}' "https://matrix.org/_matrix/client/r0/login" | grep -Po '"access_token":.*?[^\\]",' | cut -d'"' -f4)
        MATRIX_MESSAGE="GitHub Actions [$GITHUB_WORKFLOW]: Updated base image $GITHUB_SHA"
        curl 'https://matrix.org/_matrix/client/r0/rooms/!AJlEMsztoOToHdwijN%3Amatrix.org/send/m.room.message/?access_token='$MATRIX_ACCESS_TOKEN -X PUT --data '{"msgtype":"m.text","body":"'"$MATRIX_MESSAGE"'"}'
