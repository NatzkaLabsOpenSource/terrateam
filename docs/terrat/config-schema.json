{
  "$schema": "http://json-schema.org/draft-04/schema#",
  "definitions": {
    "tags": {
      "type": "array",
      "items": { "type": "string" }
    },
    "terraform-version": {
      "type": "string"
    },
    "permission": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string"
          },
          "permissions": {
            "type": "string"
          }
        },
        "required": [
          "id",
          "permissions"
        ]
      }
    },
    "run-on": {
      "type": "string",
      "enum": [
        "failure",
        "always",
        "success"
      ]
    },
    "hook-op-run": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "run"
        },
        "cmd": {
          "type": "array",
          "items": { "type": "string" }
        },
        "capture_output": {
          "type": "boolean",
          "default": false
        },
        "run_on": { "$ref": "#/definitions/run-on" },
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false,
      "required": [
        "type",
        "cmd"
      ]
    },
    "hook-op-slack": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "slack"
        },
        "msg": {
          "type": "string"
        },
        "run_on": { "$ref": "#/definitions/run-on" }
      },
      "additionalProperties": false,
      "required": [
        "type",
        "msg"
      ]
    },
    "hook-op-env": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "env"
        },
        "name": {
          "type": "string"
        },
        "cmd": {
          "type": "array",
          "items": { "type": "string" }
        },
        "trim_trailing_newlines": {
          "type": "boolean",
          "default": true
        }
      },
      "additionalProperties": false,
      "required": [
        "type",
        "name",
        "cmd"
      ]
    },
    "hook-op": {
      "oneOf": [
        { "$ref": "#/definitions/hook-op-run" },
        { "$ref": "#/definitions/hook-op-slack" },
        { "$ref": "#/definitions/hook-op-env" }
      ]
    },
    "hook-list": {
      "type": "array",
      "items": { "$ref": "#/definitions/hook-op" }
    },
    "hook": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pre": { "$ref": "#/definitions/hook-list" },
        "post": { "$ref": "#/definitions/hook-list" }
      }
    },
    "workflow-op-init": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "const": "init"
        },
        "extra_args": {
          "type": "array",
          "items": { "type": "string" }
        },
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "required": [
        "type"
      ]
    },
    "workflow-op-plan": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "const": "plan"
        },
        "extra_args": {
          "type": "array",
          "items": { "type": "string" }
        },
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "required": [
        "type"
      ]
    },
    "workflow-op-apply": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "const": "apply"
        },
        "extra_args": {
          "type": "array",
          "items": { "type": "string" }
        },
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "retry": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": false
            },
            "tries": {
              "type": "integer",
              "default": 3
            },
            "backoff": {
              "type": "number",
              "default": 3.0
            },
            "initial_sleep": {
              "type": "integer",
              "default": 5
            }
          }
        }
      },
      "required": [
        "type"
      ]
    },
    "workflow-op-list": {
      "type": "array",
      "items": {
        "oneOf": [
          { "$ref": "#/definitions/workflow-op-init" },
          { "$ref": "#/definitions/workflow-op-plan" },
          { "$ref": "#/definitions/workflow-op-apply" },
          { "$ref": "#/definitions/hook-op-run" },
          { "$ref": "#/definitions/hook-op-slack" },
          { "$ref": "#/definitions/hook-op-env" }
        ]
      }
    },
    "workflow-entry": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tag_query": {
          "type": "string"
        },
        "terragrunt": {
          "type": "boolean",
          "default": false
        },
        "terraform_version": {
          "$ref": "#/definitions/terraform-version"
        },
        "plan": { "$ref": "#/definitions/workflow-op-list" },
        "apply": { "$ref": "#/definitions/workflow-op-list" }
      },
      "required": [
        "tag_query"
      ]
    },
    "dir": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "tags": { "$ref": "#/definitions/tags" },
        "create_and_select_workspace": {
          "type": "boolean",
          "default": true
        },
        "workspaces": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "tags": { "$ref": "#/definitions/tags" }
            },
            "required": [
              "tags"
            ]
          }
        },
        "when_modified": {
          "$ref": "#/definitions/when-modified-nullable"
        }
      }
    },
    "when-modified": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "file_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": ["**/*.tf", "**/*.tfvars"]
        },
        "autoplan": {
          "type": "boolean",
          "default": true
        },
        "autoapply": {
          "type": "boolean",
          "default": false
        },
        "autoplan_draft_pr": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "when-modified-nullable": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "file_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "autoplan": {
          "type": "boolean"
        },
        "autoapply": {
          "type": "boolean"
        },
        "autoplan_draft_pr": {
          "type": "boolean"
        }
      }
    },
    "automerge": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "delete_branch": {
          "type": "boolean",
          "default": false
        }
      }
    },
    "version-1": {
      "additionalProperties": false,
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "destination_branches": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "version": {
          "type": "string",
          "default": "1",
          "const": "1"
        },
        "parallel_runs": {
          "type": "integer",
          "default" : 3
        },
        "when_modified": {
          "$ref": "#/definitions/when-modified"
        },
        "automerge": {
          "$ref": "#/definitions/automerge"
        },
        "checkout_strategy": {
          "type": "string",
          "enum": [
            "merge",
            "checkout"
          ],
          "default": "merge"
        },
        "cost_estimation": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true
            },
            "provider": {
              "type": "string",
              "default": "infracost",
              "enum": ["infracost"]
            },
            "currency": {
              "type": "string",
              "default": "USD"
            }
          }
        },
        "create_and_select_workspace": {
          "type": "boolean",
          "default": true
        },
        "default_tf_version": {
          "$ref": "#/definitions/terraform-version"
        },
        "hooks": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "plan": { "$ref": "#/definitions/hook" },
            "apply": { "$ref": "#/definitions/hook" }
          }
        },
        "workflows": {
          "type": "array",
          "items": { "$ref": "#/definitions/workflow-entry" }
        },
        "dirs": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/dir" }
        }
      }
    }
  },
  "oneOf": [
    { "$ref": "#/definitions/version-1" }
  ]
}
