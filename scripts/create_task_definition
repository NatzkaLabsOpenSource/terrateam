#!/usr/bin/env bash
set -euf -o pipefail

# Fetch the current service information
aws ecs describe-services --cluster terrateam-app --services terrateam-app-service > service.json
TASK_DEF_ARN=$(jq -r '.services[0].taskDefinition' service.json)

# Fetch the current task definition
aws ecs describe-task-definition --task-definition "${TASK_DEF_ARN}" > task-def.json

# Update the task definition with the new image tag
jq --arg IMAGE "ghcr.io/terrateamio/terrat-ee:${VERSION_TAG}" \
  '.taskDefinition.containerDefinitions[0].image = $IMAGE |
   del(.taskDefinition.taskDefinitionArn, .taskDefinition.revision, .taskDefinition.status, .taskDefinition.requiresAttributes, .taskDefinition.registeredBy, .taskDefinition.registeredAt)' \
  task-def.json > updated-task-def.json

cat updated-task-def.json

echo "Updated task definition written to updated-task-def.json"
